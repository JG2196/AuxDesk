@using Data;
@using Microsoft.Maui.Storage
@using System.IO
@using System.Text.Json

@inject NavigationManager _navigationManager

@page "/"

<h3>AuxDesk</h3>

<div class="row gx-3">
    <div class="col">
        <div class="p-2">
            <h5><b>Weeks Tasks</b></h5>
            <div class="input-group mb-3  text-center">
                <span class="input-group-text" id="inputGroup-sizing-default">Date</span>
                <input type="date" class="form-control" aria-label="Sizing example input" @onchange="SelectDate" value="@DateTime.Today.ToString("yyyy-MM-dd")" aria-describedby="inputGroup-sizing-default">
                    
            </div>
            <button type="button" class="btn btn-primary" style="width:100%" @onclick="DirectToNewTask" ><b>+</b></button>
            
            @foreach (UserTask userTask in listDaysUserTasks)
            {
                <div class="card" style="margin-top:8px">
                    <div class="card-body">
                        <div class="row">
                            <div class="col">
                                <h6 class="card-title"><b>@userTask.UserTaskData.Title</b></h6>
                            </div>
                            <div class="col" >
                                    @if (userTask.Priority == 1) {
                                        <p class="text-center fw-semibold" style="background-color:red;border-radius:4px">High</p>
                                    }
                                    @if (userTask.Priority == 2)
                                    {
                                        <p class="text-center fw-semibold" style="background-color:orange;border-radius:4px">Medium</p>
                                    }
                                    @if (userTask.Priority == 3)
                                    {
                                        <p class="text-center fw-semibold" style="background-color:green;border-radius:4px">Low</p>
                                    }
                            </div>
                        </div>
                        <div class="row">
                            <div class="col">
                                @if (userTask.StartDateTime == null) {
                                    <p class="text-center fw-semibold" style="width:100px;background-color:#dee2e6;border-radius:4px">Not started</p>
                                }
                                @if (userTask.StartDateTime != null && !userTask.IsDone)
                                {
                                    <p class="text-center fw-semibold" style="width:100px;background-color:yellow;border-radius:4px">In progress</p>
                                }
                                @if (userTask.IsDone)
                                {
                                    <p class="text-center fw-semibold" style="width:100px;background-color:green;border-radius:4px">Done</p>
                                }
                            </div>
                            <div class="col">
                                <div class="btn-toolbar" role="toolbar">
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-primary">Open</button>
                                    </div>
                                    <div class="btn-group" style="padding-left:8px">
                                        <button type="button" class="btn btn-danger" @onclick="() => DeleteTask(userTask.TaskGUID)">Delete</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
        
    <div class="col">
        <div class="p-2">Task</div>
    </div>
        
    <div class="col">
        <div class="p-2">Timer</div>
    </div>
        
    <div class="col">
        <div class="p-2">Analytics</div>
    </div>
</div>

@code {

    private List<UserTask> listDaysUserTasks = new List<UserTask>();
    DateOnly taskDate;

    // FileSystem.AppDataDirectory - points to your app’s sandboxed data folder
    private readonly string taskPath = Path.Combine(FileSystem.AppDataDirectory, "userTasks.json");

    protected override void OnInitialized()
    {
        taskDate = DateOnly.FromDateTime(DateTime.UtcNow);
        Load();
    }

    private void DirectToNewTask()
    {
        _navigationManager.NavigateTo("/newTask");
    }

    private void SelectDate(ChangeEventArgs e)
    {
        DateOnly newDate;

        DateOnly.TryParse(e.Value.ToString(), out newDate);
        taskDate = newDate;
        Load();
    }

    private List<UserTask> GetUserTasks()
    {
        List<UserTask> listUserTasks = new();

        if (!File.Exists(taskPath)) { return null; }

        var contents = File.ReadAllText(taskPath);
        var savedItems = JsonSerializer.Deserialize<List<UserTask>>(contents);
        listUserTasks.AddRange(savedItems);

        return listUserTasks;
    }

    private List<UserTask> FilterTasks(List<UserTask> listUserTasks)
    {
        List<UserTask> filterUserTasks = listUserTasks.Where(task => task.AssignedDate == taskDate).ToList();
        filterUserTasks = filterUserTasks.OrderBy(task => task.Priority).ToList();

        return filterUserTasks;
    }

    private void Load()
    {
        List<UserTask> listUserTasks = GetUserTasks();
        listDaysUserTasks = FilterTasks(listUserTasks);
    }

    private void DeleteTask(string taskGUID)
    {
        List<UserTask> listUserTasks = GetUserTasks();

        listUserTasks.RemoveAll(task => task.TaskGUID == taskGUID);

        Save(listUserTasks);

        listDaysUserTasks = FilterTasks(listUserTasks);
    }

    private async Task Save(List<UserTask> listUserTasks)
    {
        var contents = JsonSerializer.Serialize(listUserTasks);

        File.WriteAllText(taskPath, contents);

        Console.WriteLine("List Saved", $"List has been saved to {taskPath}");
    }
}
