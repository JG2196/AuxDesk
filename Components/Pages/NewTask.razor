@using Data;
@using Microsoft.Maui.Storage
@using System.IO
@using System.Text.Json

@using Models;
@using Services;

@inject NavigationManager _navigationManager;
@inject ITaskService _taskService;
@page "/newTask"

<h3>NewTask</h3>

<div class="p-2">
    <div class="input-group mb-3">
        <input type="text" class="form-control" aria-label="Text input with dropdown button" placeholder="Title..." @bind="taskTitle">
        <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" @onclick="ToggleDropdownPriority" type="button">
                @selectedPriority
            </button>
            <ul class="dropdown-menu @(isDropdownOpenPriorty ? "show" : "")" style="@(isDropdownOpenPriorty ? "position: absolute; inset: 0px auto auto 0px; margin: 0px; transform: translate3d(0px, 40px, 0px);" : "")">
                <li><a class="dropdown-item" @onclick="@( () => SelectPriority(1))">High</a></li>
                <li><a class="dropdown-item" @onclick="@( () => SelectPriority(2))">Medium</a></li>
                <li><a class="dropdown-item" @onclick="@(() => SelectPriority(3))">Low</a></li>
            </ul>
        </div>
    </div>

    <div class="input-group mb-3">
        <span class="input-group-text" @bind="taskDate" id="inputGroup-sizing-default">Start Date</span>
        <input type="date" class="form-control" aria-label="Sizing example input" @bind="taskDate">
    </div>

    <div class="input-group" style="height:30vh">
        <textarea class="form-control" aria-label="With textarea" placeholder="Notes" @bind="taskNotes"></textarea>
    </div>

    <div class="btn-toolbar" role="toolbar" style="margin-top:16px">
        <div class="btn-group">
            <button type="button" class="btn btn-primary" @onclick="CreateTask">Create</button>
        </div>
        <div class="btn-group" style="padding-left:8px">
            <button type="button" class="btn btn-danger" @onclick="CancelTask">Cancel</button>
        </div>
    </div>
</div>
@code {

    private string? taskTitle;
    private string? taskNotes;
    private int taskPriority = 2;
    DateOnly taskDate = DateOnly.FromDateTime(DateTime.UtcNow);
    private bool isDropdownOpenPriorty = false;
    private string selectedPriority = "Medium";
    List<TaskItem> listTaskItems = new();

    private void ToggleDropdownPriority()
    {
        isDropdownOpenPriorty = !isDropdownOpenPriorty;
    }

    private void SelectPriority(int priority)
    {
        taskPriority = priority;
        isDropdownOpenPriorty = false;
        selectedPriority = "Low";

        if (priority == 1) { selectedPriority = "High"; }
        else if (priority == 2) { selectedPriority = "Medium"; }
    }

    private void CancelTask()
    {
        _navigationManager.NavigateTo("/");
    }

    private async void CreateTask()
    {
        TaskItem newTaskItem = new();

        newTaskItem.TaskGUID = Guid.NewGuid().ToString();
        newTaskItem.Title = taskTitle;
        newTaskItem.Notes = taskNotes;
        newTaskItem.Priority = taskPriority;
        newTaskItem.AssignedDate = taskDate;

        // Validate on domain layer
        string validationMessage = string.Empty;
        bool bInvalid = false;
        if (string.IsNullOrEmpty(newTaskItem.Title))
        {
            validationMessage += "Title is required.";
            bInvalid = true;
        }
        if (newTaskItem.AssignedDate == null)
        {
            validationMessage += " Valid date is required.";
            bInvalid = true;
        }
        if (bInvalid)
        {
            await App.Current.MainPage.DisplayAlert("Validation Error", validationMessage, "OK");
            return;
        }

        if (listTaskItems.Count == 0)
        {
            listTaskItems = await _taskService.GetTaskItemsAsync(null);
        }

        await _taskService.SaveTaskItemAsync(listTaskItems, newTaskItem);

        taskTitle = string.Empty;
        taskNotes = string.Empty;

        await App.Current.MainPage.DisplayAlert("Task Saved", "Task saved sucessfully", "OK");
    }
}
