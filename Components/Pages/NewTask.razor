@using Data;
@using AuxDeskServices;
@using Microsoft.Maui.Storage
@using System.IO
@using System.Text.Json

@inject NavigationManager _navigationManager;
@page "/newTask"

<h3>NewTask</h3>

<div class="p-2">
    <div class="input-group mb-3">
        <input type="text" class="form-control" aria-label="Text input with dropdown button" placeholder="Title..." @bind="taskTitle">
        <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" @onclick="ToggleDropdownPriority" type="button">
                @selectedPriority
            </button>
            <ul class="dropdown-menu @(isDropdownOpenPriorty ? "show" : "")" style="@(isDropdownOpenPriorty ? "position: absolute; inset: 0px auto auto 0px; margin: 0px; transform: translate3d(0px, 40px, 0px);" : "")">
                <li><a class="dropdown-item" @onclick="@( () => SelectPriority(1))">High</a></li>
                <li><a class="dropdown-item" @onclick="@( () => SelectPriority(2))">Medium</a></li>
                <li><a class="dropdown-item" @onclick="@(() => SelectPriority(3))">Low</a></li>
            </ul>
        </div>
    </div>

    <div class="input-group mb-3">
        <span class="input-group-text" @bind="taskDate" id="inputGroup-sizing-default">Start Date</span>
        <input type="date" class="form-control" aria-label="Sizing example input" @bind="taskDate">
    </div>

    <div class="input-group" style="height:30vh">
        <textarea class="form-control" aria-label="With textarea" placeholder="Notes" @bind="taskNotes"></textarea>
    </div>

    <div class="btn-toolbar" role="toolbar" style="margin-top:16px">
        <div class="btn-group">
            <button type="button" class="btn btn-primary" @onclick="CreateTask">Create</button>
        </div>
        <div class="btn-group" style="padding-left:8px">
            <button type="button" class="btn btn-danger" @onclick="CancelTask">Cancel</button>
        </div>
    </div>
</div>
@code {

    AuxDeskServices _auxDeskServices = new AuxDeskServices();
    private List<UserTask> listUserTasks = new();
    private string? taskTitle;
    private string? taskNotes;
    private int taskPriority = 2;

    DateOnly taskDate = DateOnly.FromDateTime(DateTime.UtcNow);

    private bool isDropdownOpenPriorty = false;
    private string selectedPriority = "Medium";

    protected override void OnInitialized()
    {
        //AuxDeskServices _auxDeskServices = new AuxDeskServices();

        listUserTasks = _auxDeskServices.GetUserTasks();
    }

    private void ToggleDropdownPriority()
    {
        isDropdownOpenPriorty = !isDropdownOpenPriorty;
    }

    private void SelectPriority(int priority)
    {
        taskPriority = priority;
        isDropdownOpenPriorty = false;
        selectedPriority = "Low";
        
        if (priority == 1) { selectedPriority = "High"; }
        else if (priority == 2) { selectedPriority = "Medium"; }
    }
    private void CancelTask()
    {
        _navigationManager.NavigateTo("/");
    }

    private async Task CreateTask()
    {
        if (!string.IsNullOrWhiteSpace(taskTitle))
        {
            string taskGUID = Guid.NewGuid().ToString();

            TaskData taskData = new TaskData
            {
                TaskGUID = taskGUID,
                Title = taskTitle,
                Notes = taskNotes,
            };

            listUserTasks.Add(new UserTask
            {
                TaskGUID = taskGUID,
                AssignedDate = taskDate,
                Priority = taskPriority,
                UserTaskData = taskData
            });

            taskTitle = string.Empty;
            taskNotes = string.Empty;
            SelectPriority(2);
            taskDate = DateOnly.FromDateTime(DateTime.UtcNow);

            await Save();
        }
    }
    private async Task Save()
    {
        //AuxDeskServices _auxDeskServices = new AuxDeskServices();
        _auxDeskServices.Save(listUserTasks, null, false);
        await App.Current.MainPage.DisplayAlert("Task Saved", $"Task saved sucessfully", "OK");
    }
}
