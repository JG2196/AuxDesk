@using Data;
@using AuxDeskServices;

@page "/recycle"

<h3>Recycle</h3>

<div class="row gx-3">
    <div class="col-sm-6">
        <div class="p-2">
            <h6><b>Deleted Tasks</b></h6>
            <div class="border border-primary p-3 rounded-3" style="height:85vh;border-color:#65cf9e !important; background-color:rgba(0, 0, 0, 0.2)">
            <div class="row row-cols-2">
            @foreach (UserTask userTask in listUsersDeletedTasks)
            {
                
                <div class="col">
                    <div class="card" style="margin-top:8px">
                        <div class="card-body">
                            <div class="row">
                                <div class="col" @onclick="() => SelectTask(userTask.TaskGUID)">
                                    <h6 class="card-title"><b>@userTask.UserTaskData.Title</b></h6>
                                </div>
                                <div class="col" >
                                    @if (userTask.Priority == 1) {
                                        <p class="text-center fw-semibold" style="background-color:red;border-radius:4px">High</p>
                                    }
                                    @if (userTask.Priority == 2)
                                    {
                                        <p class="text-center fw-semibold" style="background-color:orange;border-radius:4px">Medium</p>
                                    }
                                    @if (userTask.Priority == 3)
                                    {
                                        <p class="text-center fw-semibold" style="background-color:green;border-radius:4px">Low</p>
                                    }
                                </div>
                            </div>
                            <div class="row">
                                <div class="col">
                                    <div class="btn-toolbar" role="toolbar">
                                        <div class="btn-group" style="padding-left:8px">
                                            <button type="button" class="btn btn-danger" @onclick="() => RestoreTask(userTask.TaskGUID)">Restore</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
               
            }
             </div>
             </div>
        </div>
    </div>
    <div class="col-sm-6">
        <div class="p-2">
            <h6><b>Selected Task</b></h6>
            <div class="border border-primary p-3 rounded-3" style="height:85vh;border-color:#65cf9e !important; background-color:rgba(0, 0, 0, 0.2)">
            <div class="input-group mb-3">
                <input type="text" class="form-control" placeholder="Title..." value="@selectedTask.UserTaskData.Title" disabled>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" disabled>@selectedPriority</button>
                </div>
            </div>
            <div class="input-group mb-3  text-center">
                <span class="input-group-text" id="inputGroup-sizing-default" disabled>Date</span>
                <input type="date" class="form-control" aria-label="Sizing example input" value="@selectedTask.AssignedDate.ToString("yyyy-MM-dd")" aria-describedby="inputGroup-sizing-default" disabled>
            </div>
            <div class="input-group" style="height:60vh">
                <textarea class="form-control" aria-label="With textarea" placeholder="Notes" disabled>@selectedTask.UserTaskData.Notes</textarea>
            </div>
            </div>
        </div>
    </div>
</div>

@code {
    AuxDeskServices _auxDeskServices = new AuxDeskServices();
    private List<UserTask> listUsersDeletedTasks = new List<UserTask>();
    private UserTask selectedTask = new UserTask();

    private bool isDropdownOpenPriorty = false;
    private string selectedPriority = "Medium";
    private int taskPriority = 2;

    protected override void OnInitialized()
    {
        AuxDeskServices _auxDeskServices = new AuxDeskServices();

        List<DeletedTask> listDeletedTasks = _auxDeskServices.GetDeletedTasks();

        if (listDeletedTasks.Count == 0)
        {
            return;
        }

        List<UserTask> listUserTasks = _auxDeskServices.GetUserTasks();

        foreach (DeletedTask deletedTask in listDeletedTasks)
        {
            UserTask selectedTask = listUserTasks.FirstOrDefault(userTask => userTask.TaskGUID == deletedTask.TaskGUID);
            if (selectedTask != null)
            {
                listUsersDeletedTasks.Add(selectedTask);
            }
        }
    }
    private void RestoreTask(string taskGUID)
    {
        // Get all tasks
        List<UserTask> listUserTasks = _auxDeskServices.GetUserTasks();

        // Find task by TaskGUID
        UserTask selectedTask = listUserTasks.FirstOrDefault(userTask => userTask.TaskGUID == taskGUID);

        // Set isDeleted to false
        selectedTask.IsDeleted = false;

        List<DeletedTask> listDeletedTasks = _auxDeskServices.GetDeletedTasks();
        listDeletedTasks.RemoveAll(deletedTask => deletedTask.TaskGUID == taskGUID);

        listUsersDeletedTasks.RemoveAll(deletedTask => deletedTask.TaskGUID == taskGUID);
        // Save all tasks
        _auxDeskServices.Save(listUserTasks, null, false);
        _auxDeskServices.Save(null, listDeletedTasks, true);

        //StateHasChanged();
    }
    private void SelectTask(string taskGUID)
    {
        selectedTask = listUsersDeletedTasks.FirstOrDefault(task => task.TaskGUID == taskGUID);
    }
}
